<% @onload = "initialize();" %>
<% content_for :head do -%>
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key=<%= GOOGLE_MAPS_API_KEY %>" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
function initialize() {
  if (GBrowserIsCompatible()) {
    var latlng = new GLatLng(<%= @facility.lat %>,<%= @facility.lng %>);
    var map = new GMap2(document.getElementById("map_canvas"));
  	map.setCenter(latlng, 13);

    map.addControl(new GLargeMapControl());
    map.addControl(new GMenuMapTypeControl());

    map.removeMapType(G_SATELLITE_MAP);
    var mapControl = new GMapTypeControl();
    map.addControl(mapControl);

    // Create a base icon for all of our markers that specifies the
    // shadow, icon dimensions, etc.
    var baseIcon = new GIcon(G_DEFAULT_ICON);
    baseIcon.shadow = "http://www.google.com/mapfiles/shadow50.png";
    baseIcon.iconSize = new GSize(20, 34);
    baseIcon.shadowSize = new GSize(37, 34);
    baseIcon.iconAnchor = new GPoint(9, 34);
    baseIcon.infoWindowAnchor = new GPoint(9, 2);

    function createMarker(lat, lng, index, status, info) {
      point = new GLatLng(lat, lng);

      var numberIcon = new GIcon(baseIcon);
      numberIcon.image = "/images/markers/" + status + "/marker" + index + ".png";

      markerOptions = { icon:numberIcon };
      var marker = new GMarker(point, markerOptions);
      GEvent.addListener(marker, "click", function() {
        marker.openInfoWindowHtml(info);
      });
      return marker;
    }

    <% @nearby.each_with_index do |n,index| -%>
    <% info = escape_javascript(link_to(h(n.name),n) + "<br />" + comma_to_br(h(n.address))) -%>
    map.addOverlay(createMarker(<%= "#{n.lat}, #{n.lng}, #{index+1}" %>, "<%= @status_manager.status(n).downcase %>", "<%= info %>"));
    <% end -%>

    var marker = new GMarker(latlng);
    map.addOverlay(marker);
    <% info = "<strong>#{h(@facility.name)}</strong><br />#{comma_to_br(@facility.address)}, #{@facility.postcode}" -%>
    marker.openInfoWindowHtml("<%= escape_javascript(info) %>");
  }
}
/* ]]> */
</script>
<% end -%>
<div id="map_canvas" style="border: 1px solid black; height: 360px;"></div>
