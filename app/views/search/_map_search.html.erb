<% @onload = "initialize();" %>
<% content_for :head do -%>
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key=<%= GOOGLE_MAPS_API_KEY %>" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
function initialize() {
  if (GBrowserIsCompatible()) {
    var latlng = new GLatLng(<%= @location.lat %>,<%= @location.lng %>);
    var map = new GMap2(document.getElementById("map_canvas"));
  	map.setCenter(latlng, 13);

    map.addControl(new GLargeMapControl());
    map.addControl(new GMenuMapTypeControl());

    map.removeMapType(G_SATELLITE_MAP);
    var mapControl = new GMapTypeControl();
    map.addControl(mapControl);

    var locationIcon = new GIcon(G_DEFAULT_ICON);
    locationIcon.image = "/images/markers/arrow.png";
    var locationMarker = new GMarker(latlng, { icon:locationIcon } )

    map.addOverlay(new GMarker(latlng));

    function createMarker(lat, lng, index, status, info) {
      point = new GLatLng(lat, lng);

      var numberIcon = new GIcon(G_DEFAULT_ICON);
      numberIcon.image = "/images/markers/" + status + "/marker" + index + ".png";

      markerOptions = { icon:numberIcon };
      var marker = new GMarker(point, markerOptions);
      GEvent.addListener(marker, "click", function() {
        marker.openInfoWindowHtml(info);
      });
      return marker;
    }

    <% @facilities.each_with_index do |n,index| -%>
    <% info = escape_javascript(link_to(h(n.name),n) + "<br />" + comma_to_br(n.address)) -%>
    var marker = createMarker(<%= "#{n.lat}, #{n.lng} , #{index+1}" %>, "<%= @status_manager.status(n).downcase %>", "<%= info %>");
    map.addOverlay(marker);
    <% end -%>
  }
}
/* ]]> */
</script>
<% end -%>
<div id="map_canvas" style="border: 1px solid black; height: 360px;"></div>
<small>You may need to scroll/zoom to find the facilitys marked on the map.</small>
<br clear="all" />
